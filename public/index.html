<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Projeto Doar Sangue</title>

    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""></script>
      <script>
        alert('Caso esteja fora da cidade de São Paulo, não serão apresentados locais de doação no momento. Pedimos que não conceda a localização, tendo assim melhor experiência com o sistema.')
      </script>
    <style>
      body {
        margin: 0px;
      }
      #mapid {
        width: 100%;
        height: 658px;
        border: none;
      }
    </style>
  </head>
  <body>
    <!-- update the version number as needed -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase.js"></script>
    <script src="https://unpkg.com/geofirestore/dist/geofirestore.js"></script>
    <script src="./firestore.js"></script>
    <div id='mapid'>
    </div>
    <script>
    //Variáveis iniciais de ambiente
    let localInicial = L.latLng(-23.565658, -46.651218);
    let raioExibicao = 5; //Km
    let distanciaBusca = raioExibicao*10;
    let check = false
    //Criação do mapa 
    var mymap = L.map('mapid', {zoomControl: false}).setView(localInicial, 15);
    mymap.locate({ setView: true, maxZoom:15 }).on("locationfound", e => {
      //Consulta de locais quando usuário passa sua localização
      setTimeout(function() {
          console.log(check)
          if(!check) {
            alert('Houve um erro de carregamento. Por favor atualize a página')
          }
        }, 10000)
      localDoacao(e.latlng, distanciaBusca).then(consulta => {
        console.log(consulta);
        check = apontaLocais(consulta);
      });
    }).on("locationerror", e => {
      //Consulta de locais quando usuário NÃO passa sua localização
      setTimeout(function() {
          console.log(check)
          if(!check) {
            alert('Houve um erro de carregamento. Por favor atualize a página')
          }
        }, 10000)
      localDoacao(localInicial, distanciaBusca).then(consulta =>{
        console.log(consulta);
        check = apontaLocais(consulta);
      });
    });
    </script>
    <script src="./mapbox.js"></script>
  </body>
</html>
